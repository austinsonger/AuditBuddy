# Filename: source_code_vulnerability_scan_configuration.py
import os
import subprocess
from datetime import datetime
import json

current_year = datetime.utcnow().strftime('%Y')
current_date = datetime.utcnow().strftime('%Y-%m-%d')

environments = {
    'private-sector': {
        'access_key': os.getenv('DEVOPS_PRIVSEC_AUTOMATION_AWS_ACCESS_KEY_ID'),
        'secret_key': os.getenv('DEVOPS_PRIVSEC_AUTOMATION_AWS_SECRET_ACCESS_KEY'),
        'region': 'us-east-1',
        'private_sector_output_file': f"/evidence-artifacts/{current_year}/private-sector/"
    },
    'federal': {
        'access_key': os.getenv('DEVOPS_FEDERAL_AUTOMATION_AWS_ACCESS_KEY_ID'),
        'secret_key': os.getenv('DEVOPS_FEDERAL_AUTOMATION_AWS_SECRET_ACCESS_KEY'),
        'region': 'us-east-1',
        'federal_output_file': f"/evidence-artifacts/{current_year}/federal/"
    }
}

def run_command(command):
    result = subprocess.run(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True)
    if result.returncode != 0:
        print(f"Error running command: {command}\n{result.stderr}")
    return result.stdout.splitlines()

for env_name, config in environments.items():
    os.environ['AWS_ACCESS_KEY_ID'] = config['access_key']
    os.environ['AWS_SECRET_ACCESS_KEY'] = config['secret_key']
    os.environ['AWS_DEFAULT_REGION'] = config['region']

    output = []

    # Replace <command>, <subcommand>, and <Placeholder> with actual values
    aws_command = [
        'aws', 'codeguru-reviewer', 'describe-repository-association',
        '--repository-association-arn', '<repository_arn>',
        '--output', 'json'
    ]

    # Run the AWS CLI command and collect the output
    command_output = run_command(aws_command)
    for line in command_output:
        output.append(json.loads(line))

    # Determine the output file path based on the environment
    if env_name == 'private-sector':
        output_file = config['private_sector_output_file'] + 'vulnerability_scan_configuration.json'
    elif env_name == 'federal':
        output_file = config['federal_output_file'] + 'vulnerability_scan_configuration.json'

    # Ensure the output directory exists
    os.makedirs(os.path.dirname(output_file), exist_ok=True)

    # Write the JSON output to the specified file path
    with open(output_file, 'w') as f:
        json.dump(output, f, indent=4)

    print(f"Configuration saved to {output_file}")
